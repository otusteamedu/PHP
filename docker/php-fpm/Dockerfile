FROM php:7.3-fpm-alpine as php-fpm-base

RUN apk add --no-cache libpq libxml2 \
    && apk add --no-cache --virtual .build-deps libxml2-dev postgresql-dev \
    && docker-php-ext-install bcmath pdo_pgsql xml \
    && apk del --purge .build-deps

RUN pecl channel-update pecl.php.net \
    && apk add --no-cache --virtual .build-deps g++ make autoconf \
    && pecl install apcu-5.1.17 \
    && pecl install xdebug-2.7.2 \
    && docker-php-ext-enable apcu xdebug \
    && apk del --purge .build-deps \
    && pecl clear-cache

FROM <composer-container> as builder

COPY . /app/smth # Forgot the default destination in Composer cont, check yourself.
RUN composer install --ignore-platfrom-reqs --no-interaction --no-ansi --no-progress --prefer-dist laravel/laravel /somewhwere/laravel \
    && composer clear-cache --no-interaction --no-ansi

FROM php-fpm-base

USER www-data

WORKDIR /var/www

COPY --from=builder --chown=www-data /somewhwere/laravel /var/www/laravel
