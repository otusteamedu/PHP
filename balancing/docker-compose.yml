version: '3'

services:

  balancer:
    container_name: balancer
    image: nginx:latest
    networks:
      workernet:
        ipv4_address: 172.28.1.1
    volumes:
      - ./config/balancer.conf:/etc/nginx/conf.d/default.conf

  worker_1:
    container_name: worker_1
    image: nginx:latest
    networks:
      workernet:
        ipv4_address: 172.28.2.1
    volumes:
      - ./code:/code
      - ./config/worker_1.conf:/etc/nginx/conf.d/default.conf
    links:
      - php_1
  php_1:
    container_name: php_1
    image: php:7-fpm
    volumes:
      - ./code:/code
    networks:
      workernet:
        ipv4_address: 172.28.3.1


  worker_2:
    container_name: worker_2
    image: nginx:latest
    networks:
      workernet:
        ipv4_address: 172.28.2.2
    volumes:
      - ./code:/code
      - ./config/worker_2.conf:/etc/nginx/conf.d/default.conf
    links:
      - php_2
  php_2:
    container_name: php_2
    image: php:7-fpm
    volumes:
      - ./code:/code
    networks:
      workernet:
        ipv4_address: 172.28.3.2

  worker_3:
    container_name: worker_3
    image: nginx:latest
    networks:
      workernet:
        ipv4_address: 172.28.2.3
    volumes:
      - ./code:/code
      - ./config/worker_3.conf:/etc/nginx/conf.d/default.conf
    links:
      - php_3
  php_3:
    container_name: php_3
    image: php:7-fpm
    volumes:
      - ./code:/code
    networks:
      workernet:
        ipv4_address: 172.28.3.3

networks:
  workernet:
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16