# Домашняя работа № 4
____
## Часть 1 - Верификация строки со скобками

### Структура
1. [composer.json](composer.json) - файл зависимостей для проекта и автозагрузкой по стандарту PSR-4
2. [post-test-nginx.php](post-test-nginx.php) - html страница с формой для отправки строки со скобками на проверку по адресу: **'/test-post'**
3. [post-test.php](post-test.php) - html страница с формой для отправки строки со скобками на проверку по адресу: **'/testpost'**
4. [nginxUsePost.conf](nginxUsePost.conf) - конфигурационный файл nginx, в который подключается скрипт bracket-checker.lua
5. [bracket-checker.lua](bracket-checker.lua) - скрипт на языке **Lua**, обрабатывающий POST запрос и верифицирующий строку.
6. [app/start.php](app/start.php) - Точка входа
7. [src/controllers](src/controllers) - место размещения контроллеров для маршрутов.
8. [TestPost.php](src/controllers/TestPost.php) - контроллер для маршрута /testpost

### Требования
1. PHP >=7.0
2. libnginx-mod-http-lua
3. Composer

### Развертывание
1. Скопировать проект из репозитория
2. Установить на сервер nginx модуль обработки команд Lua: `sudo apt install -y libnginx-mod-http-lua.`
Если используется контейнер, то в файле: `Dockerfile`  разместить команду `RUN apt install -y libnginx-mod-http-lua`
и пересобрать контейнер например с помощью команды: `docker-compose up -d --build имя_контейнера_вебсервера`
3. Настроить параметры  `server_name otus.loc;` и `root /var/www/html/otus.loc;` в файле: 'nginxUsePost.conf'
и разместить его в папке `sites-enabled`
4. Перезапустить службу nginx.
5. Установить зависимости и автозагрузку с помощью команды `>composer install`
6. Запустить браузер и в адресной строке ввести настроенный в файле: 'nginxUsePost.conf' url (изначально http://otus.loc/)
и имя файла: post-test.php либо post-test-nginx.php. Например `http://otus.loc/post-test.php`. 

### Описание 
>В первом случае `http://otus.loc/post-test.php` обработка post запроса по адресу: **'/testpost'** 
будет осуществлена средствами скрипта src/controllers/TestPost.php. Строка для проверки передается в параметре `str`.
Важно! Название адреса должно совпадать с названием обработчика. Заглавие букв не имеет значения.

>А во втором `http://otus.loc/post-test-nginx.php` POST запрос по адресу **'/test-post'** обработает скрипт Lua,
находящийся в файле `nginxUsePost.conf`, включенный в обработку директивы `location = /test-post {}`.
Строка для проверки так же передается в параметре `str`.
   

## Часть 2 - Консольный чат на сокетах

### Структура
1. [composer.json](composer.json) - файл зависимостей для проекта и автозагрузкой по стандарту PSR-4
2. [app/app.php](app/app.php) - Точка входа
3. [app/StartSocket.php](app/StartSocket.php) - В зависимости от параметра загружает клиентскую или серверную части.
4. [cli](cli) - место расположения консольных скриптов для запуска клиента или сервера
5. [Sockets](Sockets)
   1. [clientSocket.php](Sockets/clientSocket.php) - запускает клиентский мессенджер
   2. [serverSocket.php](Sockets/serverSocket.php) - запускает серверный мессенджер
   3. [serverConnections.php](Sockets/serverConnections.php) - запускает серверный мессенджер, способный принимать несколько соединений
   4. [socket.php](Sockets/socket.php) - класс работы с сокетами на низком уровне (создание, закрытие сокета, привязка к адресу, записывает и читает данные из сокета)
   5. [mainSocket.php](Sockets/mainSocket.php) - класс работы с сокетами на более высоком уровне (выбирает формат сокета - файл, сеть... принимает-отправляет-валидирует сообщения)

### Требования
1. PHP >=8.0
2. Composer
3. sockets

### Развертывание
1. Создать инфраструктуру из нескольких серверов
   1. Установить на сервер приложения модуль обработки команд Lua: `sudo apt install socket`
   Если используется контейнер, то в файле: `Dockerfile`  разместить команду `RUN docker-php-ext-install sockets`
   и пересобрать контейнер например с помощью команды: `docker-compose up -d --build имя_контейнера_приложения`
2. Скопировать проект из репозитория, для каждого сервера (или в одно место и пробросить на все сервера в качестве общей папки)
3. Выполнить composer install
4. Настроить файл .env
5. На одном из серверов в командной строке запустить скрипт `>php app.php server`
6. На остальных в командной строке запустить скрипт `>php app.php client`

### Параметры
|Параметр|Назначение|
|----|----|
|SERVER_SOCKET_FILE='/sock/socket.sock'| unix-сокет-файл должен быть тем же файлом, что и на клиентах. Необходимо обеспечить 'share' до этого файла |
|SERVER_SOCKET_HOST='172.26.0.4'| Ip-адрес нахождения сервера, для соединения по сети |
|SERVER_SOCKET_PORT=7777| Номер порта, для соединения по сети |
|SERVER_SOCKET_DOMAIN='file'| `inet`, `inet6`, `file` - тип соединения, если `file`, то через unix-сокет-файл |
|SERVER_SOCKET_MAX_CONNECTIONS=5| максимально количество соединений для режима мульти-соединений |
|SERVER_SOCKET_BUFFER_LENGTH=1024| размер буфера, который передается в сокет |
|SERVER_SOCKET_MULTICONNECTION=true| true - включает режим мульти-соединений |
|||
|CLIENT_SOCKET_FILE='/sock/socket.sock'| unix-сокет-файл должен быть тем же файлом, что и на сервере. Необходимо обеспечить 'share' до этого файла |
|CLIENT_SOCKET_HOST='172.26.0.4'| Ip-адрес нахождения клиента, для соединения по сети |
|CLIENT_SOCKET_PORT=7777| Номер порта, для соединения по сети |
|CLIENT_SOCKET_DOMAIN='file'| `inet`, `inet6`, `file` - тип соединения, если `file`, то через unix-сокет-файл |

### Описание
> Осуществляет связь между разными серверами используя socket соединение. Первым должен запускаться сервер. Потом клиенты.
> Мною было подготовлено 3 докер контейнера с установленным там PHP-FPM. Осуществлен проброс папки, где находится unix-socket-файл
> во все контейнеры. На скриншотах `screenClient1.png`, `screenClient2.png` и `screenServer.png`
> видно, как контейнеры общались между собой.
