# 1. Модульные тесты:

Данные набор тестов проверяет корректность работы бекенда. Тесты выполняются с использованием Mock-объекта репозитория и Mock-объекта сервиса А. Запрос передаваемый на бекенд должен содержать полный набор полей. Данные запроса передаются в формате JSON, ответ содержит JSON вида:
```
{
    success: true,
    errors: []
}
```
где:

* success - флаг успешной/неуспешной операции на бекенде
* errors - массив ошибок

Ожидаемые статусы ответа:

* 200 - успешная операция
* 400 - ошибка в переданных данных
* 500 - ошибка на бекенде

**Подготовка к тестам (setUp):**

Исходный набор валидных данных:
```
{
    'card_number': '4000000000000077',
    'card_holder': 'EVGENY PROKHOROV',
    'card_expiration': '10/19',
    'cvv': '123',
    'order_number': '1234567',
    'sum': '123,00',
}
```

Mock-объект репозитория содержит заказы:

| order_id | sum    | is_paid |
| -------- | ------ | ------- |
| 1234567  | 123.00 | false   |
| 1234568  | 123.00 | true    |

Mock-объект сервиса А содержит карточки:

| card_number         | success | error                  |
| ------------------- | ------- | ---------------------- |
| 4000 0000 0000 0077 | true    |                        | 
| 4000 0000 0000 0002 | false   | insufficient_funds     | 
| 4000 0000 0000 0069 | false   | expired_or_closed_card | 
| 4000 0000 0000 0127 | false   | incorrect_cvc          |
| 4000 0000 0000 0119 | false   | processing_error       |

### 1.1 Тест отправки полностью валидными данными

**Ожидаемый статус:** 200

**Ожидаемый ответ:**
```
{
    success: true,
    errors: []
}
```

### 1.2 Тест на отсутствие обязательных полей в запросе

**Правило:** 

Все поля обязательны для передачи, в случае если какое-либо поле отсутствует в наборе передаваемых данных, то ответ должен содержать текст ошибки с указанием поля, статус ответа должен быть 400.

**Примеры и ожидаемые результаты:**

| Отсутствует поле | Статус ответа | Success | Массив ошибок содержит сообщение                              |
| ---------------- | ------------- | ------- | ------------------------------------------------------------- |
| card_number      | 400           | false   | Поле "Номер карты" обязательно для заполнения                 |
| card_holder      | 400           | false   | Поле "Держатель карты" обязательно для заполнения             |
| card_expiration  | 400           | false   | Поле "Срок действия карты" обязательно для заполнения         |
| cvv              | 400           | false   | Поле "CVV" обязательно для заполнения                         |
| order_number     | 400           | false   | Что-то пошло не так, не передано значение поля "Номер заказа" |
| sum              | 400           | false   | Что-то пошло не так, не передано значение поля "Сумма"        |


### 1.3 Тест валидации поля card_number: 

**Правила:**

* Поле обязательно для заполнения
* Длинна должна быть строго 16 символов
* Значение содержит только цифры

Если выполнены все правила, статус ответа должен быть 200. Если хотя бы одно из правил не выполнено - массив ошибок должен содержать текст ошибки и статус ответа = 400


**Примеры и ожидаемые результаты:**

| Значение поля     | Статус ответа | Success | Массив ошибок содержит сообщение              |
| ----------------- | ------------- | ------- | --------------------------------------------- |
|                   | 400           | false   | Поле "Номер карты" обязательно для заполнения |
| 123456789012345   | 400           | false   | Некорректное значение поля "Номер карты"      |
| 123456789012345A  | 400           | false   | Некорректное значение поля "Номер карты"      |
| AAAAAAAAAAAAAAAA  | 400           | false   | Некорректное значение поля "Номер карты"      |
| 1234AAAAAAAAAAAAA | 400           | false   | Некорректное значение поля "Номер карты"      |
| 12345678910123456 | 200           | true    |                                               |

### 1.4 Тест валидации поля card_holder:

**Правила:**

* Поле обязательно для заполнения
* Значение должно содержать один (и только один) пробел
* Значение содержит только символы из набора [A-Za-z\-]

Если выполнены все правила, статус ответа должен быть 200. Если хотя бы одно из правил не выполнено - массив ошибок должен содержать текст ошибки и статус ответа = 400

**Примеры и ожидаемые результаты:**

| Значение поля      | Статус ответа | Success | Массив ошибок содержит сообщение                  |
| ------------------ | ------------- | ------- | ------------------------------------------------- |
|                    | 400           | false   | Поле "Держатель карты" обязательно для заполнения |
| Evgeny Pro4horov   | 400           | false   | Некорректное значение поля "Держатель карты"      |
| Ev-geny Pro4horov  | 400           | false   | Некорректное значение поля "Держатель карты"      |
| EvgenyProkhorov    | 400           | false   | Некорректное значение поля "Держатель карты"      |
| Evgeny-Prokhorov   | 400           | false   | Некорректное значение поля "Держатель карты"      |
| Ev geny Prokhorov  | 400           | false   | Некорректное значение поля "Держатель карты"      |
| Ev geny Prok horov | 400           | false   | Некорректное значение поля "Держатель карты"      |
| Evgeny Pro!!horov  | 400           | false   | Некорректное значение поля "Держатель карты"      |
| Evgeny Pr?kh?r?v   | 400           | false   | Некорректное значение поля "Держатель карты"      |
| Evg.ny Prokohorv   | 400           | false   | Некорректное значение поля "Держатель карты"      |
| evgeny prokhorov   | 200           | true    |                                                   |
| Evgeny Prokhorov   | 200           | true    |                                                   |
| EVGENY PROKHOROV   | 200           | true    |                                                   |
| EVGENY PROK-HOROV  | 200           | true    |                                                   |

### 1.5 Тест валидации поля card_expiration:

**Правила:**

* Поле обязательно для заполнения
* Значение соответствует формату MM/YY
* Содержит месяц и год больше или равный текущей дате (на момент написания 09/19)

Если выполнены все правила, статус ответа должен быть 200. Если хотя бы одно из правил не выполнено - массив ошибок должен содержать текст ошибки и статус ответа = 400

**Примеры и ожидаемые результаты:**

| Значение поля | Статус ответа | Success | Массив ошибок содержит сообщение                      |
| ------------- | ------------- | ------- | ----------------------------------------------------- |
| 9/19          | 400           | false   | Поле "Срок действия карты" обязательно для заполнения |
| октябрь 2019  | 400           | false   | Некорректное значение поля "Срок действия карты"      |
| 09.19         | 400           | false   | Некорректное значение поля "Срок действия карты"      |
| AA/BB         | 400           | false   | Некорректное значение поля "Срок действия карты"      |
| 10/19 !       | 400           | false   | Некорректное значение поля "Срок действия карты"      |
| 06/18         | 400           | false   | Некорректное значение поля "Срок действия карты"      |
| 10/19         | 200           | true    |                                                       |
| 01/20         | 200           | true    |                                                       |

### 1.6 Тест валидации поля cvv:

**Правила:**

* Поле обязательно для заполнения
* Длинна равняется 3-м символам
* Содержит только цифры

Если выполнены все правила, статус ответа должен быть 200. Если хотя бы одно из правил не выполнено - массив ошибок должен содержать текст ошибки и статус ответа = 400

**Примеры и ожидаемые результаты:**

| Значение поля | Статус ответа | Success | Массив ошибок содержит сообщение      |
| ------------- | ------------- | ------- | ------------------------------------- |
|               | 400           | false   | Поле "CVV" обязательно для заполнения |
| AAA           | 400           | false   | Некорректное значение поля "CVV"      |
| 12A           | 400           | false   | Некорректное значение поля "CVV"      |
| 1234          | 400           | false   | Некорректное значение поля "CVV"      |
| 123           | 200           | true    |                                       |

### 1.7 Тест валидации поля order_number

**Правила:**

* Поле обязательно для заполнения
* Длинна не больше 16-и символов

Если выполнены все правила, статус ответа должен быть 200. Если хотя бы одно из правил не выполнено - массив ошибок должен содержать текст ошибки и статус ответа = 400

**Примеры и ожидаемые результаты:**

| Значение поля      | Статус ответа | Success | Массив ошибок содержит сообщение                               |
| ------------------ | ------------- | ------- | -------------------------------------------------------------- |
|                    | 400           | false   | Что-то пошло не так, пустое поле "Номер заказа"                |
| 123456789012345678 | 400           | false   | Что-то пошло не так, некорректное значение поля "Номер заказа" |
| 1224344534534AAA!  | 400           | false   | Что-то пошло не так, некорректное значение поля "Номер заказа" |
| 1224344534534AA!   | 200           | true    |                                                                |
| 1234               | 200           | true    |                                                                |
| A                  | 200           | true    |                                                                |

### 1.8 Тест валидации поля sum

**Правила:**

* Поле обязательно для заполнения
* Значение содержит одну (и только одну) запятую а так же цифры
* До и после запятой есть хотя бы по одной цифре

Если выполнены все правила, статус ответа должен быть 200. Если хотя бы одно из правил не выполнено - массив ошибок должен содержать текст ошибки и статус ответа = 400

**Примеры и ожидаемые результаты:**

| Значение поля | Статус ответа | Success | Массив ошибок содержит сообщение                        |
| ------------- | ------------- | ------- | ------------------------------------------------------- |
|               | 400           | false   | Что-то пошло не так, пустое поле "Сумма"                |
| 1200          | 400           | false   | Что-то пошло не так, некорректное значение поля "Сумма" |
| 123.00        | 400           | false   | Что-то пошло не так, некорректное значение поля "Сумма" |
| 123,0!        | 400           | false   | Что-то пошло не так, некорректное значение поля "Сумма" |
| 123,12,00     | 400           | false   | Что-то пошло не так, некорректное значение поля "Сумма" |
| 1 200,00      | 400           | false   | Что-то пошло не так, некорректное значение поля "Сумма" |
| ,             | 400           | false   | Что-то пошло не так, некорректное значение поля "Сумма" |
| 100,          | 400           | false   | Что-то пошло не так, некорректное значение поля "Сумма" |
| ,20           | 400           | false   | Что-то пошло не так, некорректное значение поля "Сумма" |
| 1,201         | 200           | true    |                                                         |
| 123,00        | 200           | true    |                                                         |

### 1.9 Тест метода setOrderIsPaid

**Правила:**

* Заказ с указанным номером должен существовать в репозитории
* Сумма заказа должна совпадать с переданной в запросе суммой
* Заказ еще не был оплачен

В случае если все правила выполнены, то статус ответа должен быть 200, иначе статус ответа - 500 и массив ошибок должен содержать текст ошибки

**Примеры и ожидаемые результаты:**

| order_number | sum    | Статус ответа | Success | Массив ошибок содержит сообщение                                                  |
| ------------ | ------ | ------------- | ------- | --------------------------------------------------------------------------------- |
| 1234567      | 123.00 | 200           | true    |                                                                                   |
| 1234569      | 123.00 | 500           | false   | Произошла ошибка. Мы уже знаем о ней, наш менеджер свяжется с Вами в течении часа |
| 1234567      | 124.00 | 500           | false   | Произошла ошибка. Мы уже знаем о ней, наш менеджер свяжется с Вами в течении часа |
| 1234568      | 123.00 | 500           | false   | Произошла ошибка. Мы уже знаем о ней, наш менеджер свяжется с Вами в течении часа |

### 1.10 Тест обработки ответа от сервиса А

**Правила:**

* Сервис А отвечает в формате JSON:
```
{
    success: true,
    error_code: ''
}
```

где: 
* success - флаг успешной/неуспешной операции
* error_code - код ошибки

Если операция на сервиса А успешна, то бекенд должен вернуть статус 200, если нет - то статус 400 и массив ошибок должен содержать ошибку с описанием причины возникновения

**Примеры и ожидаемые результаты:**

| Номер карты         | Статус ответа | Success | Массив ошибок содержит сообщение                 |
| ------------------- | ------------- | ------- | ------------------------------------------------ |
| 4000 0000 0000 0077 | 200           | true    |                                                  | 
| 4000 0000 0000 0002 | 400           | false   | Ошибка списания: Недостаточно средств            |
| 4000 0000 0000 0069 | 400           | false   | Ошибка списания: Карта истекла или заблокирована | 
| 4000 0000 0000 0127 | 400           | false   | Ошибка списания: Неверный CVV                    | 
| 4000 0000 0000 0119 | 400           | false   | Не удалось списать средства. Неизвестная ошибка  | 


# 2. Интеграционные тесты:

## 2.1 Тесты "Фронт - Бекенд"

Данный набор тестов проверяет корректность работы фронтенда при валидации данных бекендом. Поскольку репозиторий и Сервис А непосоредственно связаны с ответами бекенда, то они имитриуются Mock-объектами

**Подготовка к тестам (setUp):**

Набор валидных данных для ввода:
```
{
    'card_number': '4000000000000077',
    'card_holder': 'EVGENY PROKHOROV',
    'card_expiration': '10/19',
    'cvv': '123',
    'order_number': '1234567',
    'sum': '123,00',
}
```

Mock-объект репозитория содержит заказы:

| order_id | sum    | is_paid |
| -------- | ------ | ------- |
| 1234567  | 123.00 | false   |
| 1234568  | 123.00 | true    |

Mock-объект сервиса А содержит карточки:

| card_number         | success | error                  |
| ------------------- | ------- | ---------------------- |
| 4000 0000 0000 0077 | true    |                        | 
| 4000 0000 0000 0002 | false   | insufficient_funds     | 
| 4000 0000 0000 0069 | false   | expired_or_closed_card | 
| 4000 0000 0000 0127 | false   | incorrect_cvc          |
| 4000 0000 0000 0119 | false   | processing_error       |

**Общий набор правил для тестов:**
* Статус ответа бекенда - 200, происходит редирект на страницу "Спасибо за заказ"
* Статус ответа бекенда - 400, пользователь остается на странице "Оплата", отображается блок с ошибками
* Статус ответа бекенда - 500, происходит редирект на страницу "Ошибка сервера"

### 2.1.1 Тест с полностью валидными данными

**Пример и ождиаемый результат:**

| Изменено поле | Значение поля | Пользователь на странице | Блок с ошибками отображен? |
| ------------- | ------------- | ------------------------ | -------------------------- |
|               |               | Спасибо за заказ         | Нет                        |


### 2.1.2 Тест отправки формы с незаполненными данными

Форма отправляется без заполненных полей вообще

**Ожидаемый результат:**

| Пользователь на странице | Блок с ошибками отображен? |
| ------------------------ | -------------------------- |
| Оплата                   | Да                         |

### 2.1.3 Тест с невалидными данными

**Примеры и ожидаемые результаты:**

| Изменено поле     | Значение поля      | Пользователь на странице | Блок с ошибками отображен? |
| ----------------- | ------------------ | ------------------------ | -------------------------- |
| card_number       | AAAAAAAAAAAAAAAA   | Оплата                   | Да                         |
| card_holder       | Evgeny Pro4horov   | Оплата                   | Да                         |
| card_expiration   | 05/05              | Оплата                   | Да                         |
| cvv               | 1235               | Оплата                   | Да                         |
| order_number      | 123456789012345678 | Оплата                   | Да                         |
| sum               | 127.00             | Оплата                   | Да                         |

### 2.1.4 Тест с валидными данными, но разными картами

**Примеры и ожидаемые результаты:**

| Изменено поле     | Значение поля      | Пользователь на странице | Блок с ошибками отображен? |
| ----------------- | ------------------ | ------------------------ | -------------------------- |
| card_number       | 4000000000000077   | Спасибо за заказ         | Нет                        |
| card_number       | 4000000000000002   | Оплата                   | Да                         |
| card_number       | 4000000000000069   | Оплата                   | Да                         |
| card_number       | 4000000000000127   | Оплата                   | Да                         |
| card_number       | 4000000000000119   | Оплата                   | Да                         |

### 2.1.5 Тест с валидными данными, но некорректными данными по заказу

**Примеры и ожидаемые результаты:**

| Изменено поле     | Значение поля      | Пользователь на странице | Блок с ошибками отображен? |
| ----------------- | ------------------ | ------------------------ | -------------------------- |
| order_number      | 4000000000000077   | Ошибка сервера           | Нет                        |
| order_number      | 1234568            | Ошибка сервера           | Нет                        |
| sum               | 124,00             | Ошибка сервера           | Нет                        |


## 2.2 Тесты "Бекенд - Репозиторий"

Данный набор тестов проверяет работу бекенда (в частности метода setOrderIsPaid) в связке с реальной базой данных

**Подготовка к тестам (setUp):**

Тестирование проводится на с использованием тестовой базы данных в которую заводится несколько заказов:

| order_id | sum    | is_paid |
| -------- | ------ | ------- |
| 11111111 | 100.00 | false   |
| 11111112 | 100.00 | true    |

### 2.2.1 Существующий неоплаченный заказ и некорректная сумма

**Правило:**

Если передан существующий заказ и некорректная сумма, то должно быть выброшено исключение WrongSumException

**Пример и ожидаемый результат:**

| order_id | sum    | Ожидаемый результат |
| -------- | ------ | ------------------- |
| 11111111 | 100.01 | WrongSumException   |

### 2.2.2 Несуществующий заказ

**Правило:**

Если передан несуществующих заказ, то должно быть быть выброшено исключение OrderNotFoundException

**Пример и ожидаемый результат:**

| order_id | sum    | Ожидаемый результат      |
| -------- | ------ | ------------------------ |
| 11111113 | 100.01 | OrderNotFoundException   |

### 2.2.3 Существующий, но уже оплаченный заказ

**Правило:**

Если передан существующий, но уже оплаченный заказ, то должно быть выброшено исключение OrderAlreadyPaidException

**Пример и ожидаемый результат:**

| order_id | sum    | Ожидаемый результат         |
| -------- | ------ | --------------------------- |
| 11111112 | 100.00 | OrderAlreadyPaidException   |

### 2.2.4 Существующий неоплаченный заказ и корректная сумма

**Правило:**

Если передан существующий заказ, заказ неоплачен и сумма сходится, то метод должен вернуть - true

**Пример и ожидаемый результат:**

| order_id | sum    | Ожидаемый результат |
| -------- | ------ | ------------------- |
| 11111111 | 100.00 | true                |

### 2.2.5 Изменение статуса заказа при успешной оплате

**Правило:**

Если передан существующий заказ и корректная сумма, а так же заказ еще не был оплачен, то параметр is_paid должен поменятся на true

**Подготовка к тесту:**

Создается новый заказ:

| order_id | sum    | is_paid |
| -------- | ------ | ------- |
| 11111113 | 100.00 | false   |

**Пример и ожидаемый результат:**

| order_id | sum    | Ожидаемое значение is_paid |
| -------- | ------ | -------------------------- |
| 11111113 | 100.00 | true                       |

## 2.3 Тесты "Бекенд - Сервиса А"

Данный набор тестов проверяет взаимодействие бекенда с реальным Сервисом А.

* Сервис А отвечает в формате JSON:
```
{
    success: true,
    error_code: ''
}
```

В случае успешной операции статус ответа - 200
В случае ошибки, статус ответа - 403 и error_code содержит код ошибки 

**Подготовка к тестам (setUp):**

В ходе тестирования будут использоватся тестовые данные из документации:

| card_number         | success | error                  |
| ------------------- | ------- | ---------------------- |
| 4000 0000 0000 0077 | true    |                        | 
| 4000 0000 0000 0002 | false   | insufficient_funds     | 
| 4000 0000 0000 0069 | false   | expired_or_closed_card | 
| 4000 0000 0000 0127 | false   | incorrect_cvc          |
| 4000 0000 0000 0119 | false   | processing_error       |

Исходный набор передаваемых данных:
```
{
    'card_number': '4000000000000077',
    'card_holder': 'EVGENY PROKHOROV',
    'card_expiration': '10/19',
    'cvv': '123',
    'sum': '123,00',
    'access_token': c407f036be3c5bfc74d5dqw2134qsada112
}
```

### 2.3.1 Тест передачи неверного токена

**Пример и ожидаемый результат:**

| Параметр     | Значение | Статус ответа | success | error_code  |
| ------------ | -------- | ------------- | ------- | ----------- | 
| access_token | aaa      | 403           | false   | wrong_token |

### 2.3.2 Тест передачи запроса без параметров

**Пример и ожидаемый результат:**

| Статус ответа | success | error_code    |
| ------------- | ------- | ------------- | 
| 403           | false   | empty_request |

### 2.3.3 Тест передачи пустых параметров

**Примеры и ожидаемые результаты:**

| Параметр        | Значение | Статус ответа | success | error_code    |
| --------------- | -------- | ------------- | ------- | ------------- | 
| card_number     |          | 403           | false   | wrong_request |
| card_holder     |          | 403           | false   | wrong_request |
| card_expiration |          | 403           | false   | wrong_request |
| cvv             |          | 403           | false   | wrong_request |
| sum             |          | 403           | false   | wrong_request |
| access_token    |          | 403           | false   | wrong_request |

### 2.3.4 Тест передачи запроса с отсутствующим параметром

**Примеры и ожидаемые результаты:**

| Параметр        | Значение | Статус ответа | success | error_code    |
| --------------- | -------- | ------------- | ------- | ------------- | 
| card_number     |          | 403           | false   | wrong_request |
| card_holder     |          | 403           | false   | wrong_request |
| card_expiration |          | 403           | false   | wrong_request |
| cvv             |          | 403           | false   | wrong_request |
| sum             |          | 403           | false   | wrong_request |
| access_token    |          | 403           | false   | wrong_request |

### 2.3.5 Тест передачи запроса валидными данными и разными тестовыми картами:

**Примеры и ожидаемые результаты:**

| Номер карты      | Статус ответа | success | error_code             |
| ---------------- | ------------- | ------- | ---------------------- |
| 4000000000000077 | 200           | true    |                        | 
| 4000000000000002 | 403           | false   | insufficient_funds     | 
| 4000000000000069 | 403           | false   | expired_or_closed_card | 
| 4000000000000127 | 403           | false   | incorrect_cvc          |
| 4000000000000119 | 403           | false   | processing_error       |

# 3. Системные тесты

Данный набор тестов проверяет работу преложения в целом. В ходе тестирования используется реальный тестовый репозиторий с загруженными через seed данными фильмов, сеансв и стоимости и реальный сервис А.

**Подготовка к тестам:**

В ходе тестирования будут использоватся тестовые карты из документации:

| card_number         | success | error                  |
| ------------------- | ------- | ---------------------- |
| 4000 0000 0000 0077 | true    |                        | 
| 4000 0000 0000 0002 | false   | insufficient_funds     | 
| 4000 0000 0000 0069 | false   | expired_or_closed_card | 
| 4000 0000 0000 0127 | false   | incorrect_cvc          |
| 4000 0000 0000 0119 | false   | processing_error       |

Дополнительные данные для ввода:
```
{
    'card_holder': 'EVGENY PROKHOROV',
    'card_expiration': '10/19',
    'cvv': 123
}
```

### 3.1 Тест успешной оплаты

**Сценарий:**

1. Пользователь выбирает места на фильм и нажимает кнопку оплатить
2. Открывается страница для оплаты с карты
3. Пользователь вводит номер карты - 4000 0000 0000 0077
4. Пользователь вводит все остальные данные и нажимает кнопку "Оплатить"
5. Должна открыться страница "Спасибо за заказ" с текстом: "Успешная оплата! Приятного просмотра!"

### 3.2 Тест с разными картами

**Сценарий:**

1. Пользователь выбирает места на фильм и нажимает кнопку оплатить
2. Открывается страница для оплаты с карты
3. Пользователь вводит номера карт и должен получить текст с ошибками:

| Номер карты         | Текст ошибки                                     |
| ------------------- | ------------------------------------------------ |
| 4000 0000 0000 0002 | Ошибка списания: Недостаточно средств            |
| 4000 0000 0000 0069 | Ошибка списания: Карта истекла или заблокирована | 
| 4000 0000 0000 0127 | Ошибка списания: Неверный CVV                    | 
| 4000 0000 0000 0119 | Не удалось списать средства. Неизвестная ошибка  | 

