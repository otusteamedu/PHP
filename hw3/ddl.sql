CREATE TABLE public.countries (
	id_country int2 NOT NULL GENERATED BY DEFAULT AS IDENTITY,
	short_name varchar(20) NOT NULL,
	full_name varchar(50) NOT NULL,
	CONSTRAINT countries_pk PRIMARY KEY (id_country),
	CONSTRAINT countries_un_full_name UNIQUE (full_name),
	CONSTRAINT countries_un_short_name UNIQUE (short_name)
);


CREATE TABLE public.films (
	id_film int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY,
	title varchar(50) NOT NULL,
	release_year int4 NOT NULL,
	сountry_id int2 NOT NULL,
	duration int2 NOT NULL,
	CONSTRAINT films_pk PRIMARY KEY (id_film),
	CONSTRAINT films_check CHECK ((release_year > 1880)),
	CONSTRAINT films_un UNIQUE (title, release_year, "сountry_id"),
	CONSTRAINT films_fk FOREIGN KEY ("сountry_id") REFERENCES countries(id_country)
);


CREATE TABLE public.halls (
	id_hall int2 NOT NULL,
	title varchar(20) NOT NULL,
	CONSTRAINT halls_pk PRIMARY KEY (id_hall),
	CONSTRAINT halls_un UNIQUE (title)
);

CREATE TABLE public.users (
	id_user int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY,
	username varchar(100) NOT NULL,
	email varchar(100) NOT NULL,
	phone varchar(20) NOT NULL,
	CONSTRAINT users_pk PRIMARY KEY (id_user),
	CONSTRAINT users_un_email UNIQUE (email),
	CONSTRAINT users_un_phone UNIQUE (phone)
);


CREATE TABLE public.orders (
	id_order int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY,
	created_at timestamp NOT NULL,
	user_id int4 NOT NULL,
	CONSTRAINT orders_pk PRIMARY KEY (id_order),
	CONSTRAINT orders_fk FOREIGN KEY (user_id) REFERENCES users(id_user)
);

CREATE TABLE public.shows (
	id_show int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY,
	start_at timestamp NOT NULL,
	hall_id int2 NOT NULL,
	film_id int4 NOT NULL,
	price float4 NOT NULL,
	CONSTRAINT shows_pk PRIMARY KEY (id_show),
	CONSTRAINT shows_un UNIQUE (start_at, hall_id),
	CONSTRAINT shows_fk_film FOREIGN KEY (film_id) REFERENCES films(id_film),
	CONSTRAINT shows_fk_hall FOREIGN KEY (hall_id) REFERENCES halls(id_hall)
);



CREATE TABLE public.tickets (
	id_ticket int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY,
	show_id int4 NOT NULL,
	seat_id int4 NOT NULL,
	order_id int4 NOT NULL,
	CONSTRAINT tickets_pk PRIMARY KEY (id_ticket),
	CONSTRAINT tickets_un UNIQUE (show_id, seat_id),
	CONSTRAINT tickets_fk_show FOREIGN KEY (show_id) REFERENCES shows(id_show),
	CONSTRAINT tickets_fk_seat FOREIGN KEY (seat_id) REFERENCES seats(id_seat),
	CONSTRAINT tickets_fk_order FOREIGN KEY (order_id) REFERENCES orders(id_order)
);

CREATE TABLE public.seats (
	id_seat int2 NOT NULL,
	hall_id int2 NOT NULL,
	line int2 NOT NULL,
	seat int2 NOT NULL,
	CONSTRAINT seats_pk PRIMARY KEY (id_seat),
	CONSTRAINT seats_un_id_seat UNIQUE (id_seat),
	CONSTRAINT seats_un_hall_line_seat UNIQUE (hall_id, line, seat),
	CONSTRAINT seats_fk_hall FOREIGN KEY (hall_id) REFERENCES halls(id_hall)
);

INSERT INTO public.halls (id_hall, title)
VALUES
(1, 'Red Hall'),
(2, 'Green Hall');


INSERT INTO public.seats (id_seat, hall_id, line, seat)
VALUES
(1, 1, 1, 1),
(2, 1, 1, 2),
(3, 1, 1, 3),
(4, 1, 1, 4),
(5, 1, 1, 5),
(6, 1, 1, 6),
(7, 1, 1, 7),
(8, 1, 2, 1),
(9, 1, 2, 2),
(10, 1, 2, 3),
(11, 1, 2, 4),
(12, 1, 2, 5),
(13, 1, 2, 6),
(14, 1, 2, 7),
(15, 1, 3, 1),
(16, 1, 3, 2),
(17, 1, 3, 3),
(18, 1, 3, 4),
(19, 1, 3, 5),
(20, 1, 3, 6),
(21, 1, 3, 7),
(22, 1, 4, 1),
(23, 1, 4, 2),
(24, 1, 4, 3),
(25, 1, 4, 4),
(26, 1, 4, 5),
(27, 1, 4, 6),
(28, 1, 4, 7),
(29, 1, 5, 1),
(30, 1, 5, 2),
(31, 1, 5, 3),
(32, 1, 5, 4),
(33, 1, 5, 5),
(34, 1, 5, 6),
(35, 1, 5, 7),
(36, 1, 6, 1),
(37, 1, 6, 2),
(38, 1, 6, 3),
(39, 1, 6, 4),
(40, 1, 6, 5),
(41, 1, 6, 6),
(42, 1, 6, 7),
(43, 1, 7, 1),
(44, 1, 7, 2),
(45, 1, 7, 3),
(46, 1, 7, 4),
(47, 1, 7, 5),
(48, 1, 7, 6),
(49, 1, 7, 7),
(50, 2, 1, 1),
(51, 2, 1, 2),
(52, 2, 1, 3),
(53, 2, 1, 4),
(54, 2, 1, 5),
(55, 2, 1, 6),
(56, 2, 1, 7),
(57, 2, 1, 8),
(58, 2, 1, 9),
(59, 2, 1, 10),
(60, 2, 2, 1),
(61, 2, 2, 2),
(62, 2, 2, 3),
(63, 2, 2, 4),
(64, 2, 2, 5),
(65, 2, 2, 6),
(66, 2, 2, 7),
(67, 2, 2, 8),
(68, 2, 2, 9),
(69, 2, 2, 10),
(70, 2, 3, 1),
(71, 2, 3, 2),
(72, 2, 3, 3),
(73, 2, 3, 4),
(74, 2, 3, 5),
(75, 2, 3, 6),
(76, 2, 3, 7),
(77, 2, 3, 8),
(78, 2, 3, 9),
(79, 2, 3, 10),
(80, 2, 4, 1),
(81, 2, 4, 2),
(82, 2, 4, 3),
(83, 2, 4, 4),
(84, 2, 4, 5),
(85, 2, 4, 6),
(86, 2, 4, 7),
(87, 2, 4, 8),
(88, 2, 4, 9),
(89, 2, 4, 10),
(90, 2, 5, 1),
(91, 2, 5, 2),
(92, 2, 5, 3),
(93, 2, 5, 4),
(94, 2, 5, 5),
(95, 2, 5, 6),
(96, 2, 5, 7),
(97, 2, 5, 8),
(98, 2, 5, 9),
(99, 2, 5, 10),
(100, 2, 6, 1),
(101, 2, 6, 2),
(102, 2, 6, 3),
(103, 2, 6, 4),
(104, 2, 6, 5),
(105, 2, 6, 6),
(106, 2, 6, 7),
(107, 2, 6, 8),
(108, 2, 6, 9),
(109, 2, 6, 10),
(110, 2, 7, 1),
(111, 2, 7, 2),
(112, 2, 7, 3),
(113, 2, 7, 4),
(114, 2, 7, 5),
(115, 2, 7, 6),
(116, 2, 7, 7),
(117, 2, 7, 8),
(118, 2, 7, 9),
(119, 2, 7, 10),
(120, 2, 8, 1),
(121, 2, 8, 2),
(122, 2, 8, 3),
(123, 2, 8, 4),
(124, 2, 8, 5),
(125, 2, 8, 6),
(126, 2, 8, 7),
(127, 2, 8, 8),
(128, 2, 8, 9),
(129, 2, 8, 10),
(130, 2, 9, 1),
(131, 2, 9, 2),
(132, 2, 9, 3),
(133, 2, 9, 4),
(134, 2, 9, 5),
(135, 2, 9, 6),
(136, 2, 9, 7),
(137, 2, 9, 8),
(138, 2, 9, 9),
(139, 2, 9, 10),
(140, 2, 10, 1),
(141, 2, 10, 2),
(142, 2, 10, 3),
(143, 2, 10, 4),
(144, 2, 10, 5),
(145, 2, 10, 6),
(146, 2, 10, 7),
(147, 2, 10, 8),
(148, 2, 10, 9),
(149,2, 10, 10);
